<!DOCTYPE html>
<html>
<head>
    <title>Simple Chat</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="/webjars/sockjs-client/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/stomp.min.js"></script>
</head>
<body>
<div id="user-count">

</div>

<div id="chat-room">
    <div th:if="${messages}">
        <div id="message-container">
            <ul id="chat-messages">
                <li th:each="msg : ${messages}">
                    <spen th:text="${msg.sender}">Sender</spen>:
                    <span th:text="${msg.message}">Message</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<div id="call">
    <button id="WebRTC">RTC-start</button>
    <div id="myStream">
        <video id="myFace" autoplay playsinline width="400" height="400">myFace</video>
        <button id="mute">Mute</button>
        <button id="camera">Turn Camera Off</button>
        <select id="cameras"></select>
        <video id="peerFace" autoplay playsinline width="400" height="400">peerFace</video>
    </div>
</div>

<input type="text" id="chat-input" placeholder="Type your message..." />
<button onclick="sendMessage()">Send</button>

<button onclick="sendLeaveRoomMessage()">Leave</button>

<script th:inline="javascript">
    let stompClient = null;

    let username = /*[[${username}]]*/ 'default';
    let roomId = /*[[${roomId}]]*/ 'default';
    let userId = /*[[${userId}]]*/ 'default';

    const myFace = document.getElementById("myFace");
    const muteBtn = document.getElementById("mute");
    const cameraBtn = document.getElementById("camera");
    const camerasSelect = document.getElementById("cameras");
    const call = document.getElementById("myStream");
    const rtcBtn = document.getElementById("WebRTC");

    // 일단 가려 놓자. 버튼 하나 따로 생성해야 될듯
    call.hidden = true;

    let myStream;
    let muted = false;
    let cameraOff = false;
    let roomName;
    let myPeerConnection;
    let myDataChannel;

    document.getElementById("chat-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });


    function connect() {
        let socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/sub/chat/room/' + roomId, function (chatMessage) {
                showChatMessage(JSON.parse(chatMessage.body));
            });
            sendJoinRoomMessage();
        });
    }

    // 방에 참여하기 위한 메시지 전송
    function sendJoinRoomMessage() {
        let enterMessage = {
            chatRoom: roomId,
            chatRoomUser: userId,
            sender: username,
            type: "JOIN"
        };
        stompClient.send("/pub/chat/join", {}, JSON.stringify(enterMessage));
    }

    // 메시지 전송
    function sendMessage() {
        let messageInput = document.getElementById("chat-input");
        let chatMessage = {
            chatRoom: roomId,
            message: messageInput.value,
            sender: username,
            chatRoomUser: userId,
            type: "CHAT"
        };
        stompClient.send("/pub/chat/send", {}, JSON.stringify(chatMessage));
        messageInput.value = "";
    }

    // 방에서 나가기 위한 메시지 전송
    function sendLeaveRoomMessage() {
        let leaveMessage = {
            chatRoom: roomId,
            chatRoomUser: userId,
            sender: username,
            type: "LEAVE"
        };
        stompClient.send("/pub/chat/leave", {}, JSON.stringify(leaveMessage));

        // Disconnect the client
        if (stompClient !== null) {
            stompClient.disconnect();
        }

        window.location.href = "/chat/rooms";
    }

    function showChatMessage(message) {
        let messagesList = document.getElementById("chat-messages");
        let messageDiv = document.createElement("li");

        if (message.type === 'JOIN') {
            messageDiv.classList.add("join-message"); // CSS 클래스를 추가하여 스타일 적용
            messageDiv.textContent = message.message;
            updateUserCount();
        } else if (message.type === 'LEAVE') {
            messageDiv.classList.add("leave-message"); // CSS 클래스를 추가하여 스타일 적용
            messageDiv.textContent = message.message;
            updateUserCount();
        } else {
            messageDiv.classList.add("chat-message");
            messageDiv.textContent = message.sender + ": " + message.message;
        }

        messagesList.appendChild(messageDiv);
        messagesList.scrollTop = messagesList.scrollHeight; // 자동 스크롤 다운
    }

    function updateUserCount(){
        $.ajax({
            url: '/chat/userCount/' + roomId,
            method: 'GET',
            success: function (res){
                let userCountElement = document.getElementById('user-count');
                userCountElement.innerText = 'User Count : ' + res;
            },
            error: function (err){
                console.error('Failed to update user count : ' + err);
            }
        })

        // RTC code

        async function getCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter((device) => device.kind === "videoinput");
                const currentCamera = myStream.getVideoTracks()[0];
                cameras.forEach((camera) => {
                    const option = document.createElement("option");
                    option.value = camera.deviceId;
                    option.innerText = camera.label;
                    if (currentCamera.label === camera.label) {
                        option.selected = true;
                    }
                    camerasSelect.appendChild(option);
                });
            } catch (e) {
                console.log(e);
            }
        }

        async function getMedia(deviceId) {
            const initialConstrains = {
                audio: true,
                video: { facingMode: "user" },
            };
            const cameraConstraints = {
                audio: true,
                video: { deviceId: { exact: deviceId } },
            };
            try {
                myStream = await navigator.mediaDevices.getUserMedia(
                    deviceId ? cameraConstraints : initialConstrains
                );
                myFace.srcObject = myStream;
                if (!deviceId) {
                    await getCameras();
                }
            } catch (e) {
                console.log(e);
            }
        }

        function handleMuteClick() {
            myStream
                .getAudioTracks()
                .forEach((track) => (track.enabled = !track.enabled));
            if (!muted) {
                muteBtn.innerText = "Unmute";
                muted = true;
            } else {
                muteBtn.innerText = "Mute";
                muted = false;
            }
        }
        function handleCameraClick() {
            myStream
                .getVideoTracks()
                .forEach((track) => (track.enabled = !track.enabled));
            if (cameraOff) {
                cameraBtn.innerText = "Turn Camera Off";
                cameraOff = false;
            } else {
                cameraBtn.innerText = "Turn Camera On";
                cameraOff = true;
            }
        }

        // 일단 이 부분 결국 배포하지 않으면 구현 못하기 때문에 일단 html부터 해보자
        async function handleCameraChange() {
            await getMedia(camerasSelect.value);
            if (myPeerConnection) {
                const videoTrack = myStream.getVideoTracks()[0];
                const videoSender = myPeerConnection
                    .getSenders()
                    .find((sender) => sender.track.kind === "video");
                await videoSender.replaceTrack(videoTrack);
            }
        }

        async function startCall() {
            call.hidden = false;
            await getMedia();
        }

        muteBtn.addEventListener("click", handleMuteClick);
        cameraBtn.addEventListener("click", handleCameraClick);
        camerasSelect.addEventListener("input", handleCameraChange);
        rtcBtn.addEventListener("click", startCall)
    }

    connect();
    updateUserCount();
</script>
</body>
</html>
